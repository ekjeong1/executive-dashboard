<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ëŒ€í‘œë‹˜ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#fff;border-radius:15px;padding:25px;margin-bottom:25px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header h1{font-size:28px;color:#333;margin-bottom:10px}
    .status-bar{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
    .status-item{display:flex;align-items:center;gap:8px;padding:8px 15px;background:#f0f0f0;border-radius:20px;font-size:14px}
    .status-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .main-grid{display:grid;grid-template-columns:2fr 1fr;gap:25px}
    @media(max-width:1024px){.main-grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
    .card-title{font-size:20px;font-weight:600;color:#333}
    .badge{padding:5px 12px;background:#667eea;color:#fff;border-radius:15px;font-size:12px;font-weight:600}
    .urgent-panel{background:linear-gradient(135deg,#f59e0b 0%,#ea580c 100%);color:#fff;border-radius:15px;padding:20px;margin-bottom:25px}
    .request-types{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px}
    .request-type-btn{padding:10px;background:rgba(255,255,255,.2);border:2px solid transparent;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:.3s}
    .request-type-btn.active{background:rgba(255,255,255,.3);border-color:#fff}
    .message-input{width:100%;padding:15px;border:none;border-radius:10px;font-size:16px;margin-bottom:15px;resize:vertical;min-height:100px}
    .action-buttons{display:flex;gap:10px}
    .btn{padding:12px 25px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:8px}
    .btn-send{background:#fff;color:#ea580c}
    .btn-send:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .meeting-list{max-height:400px;overflow-y:auto}
    .meeting-item{padding:15px;background:#f8f9fa;border-radius:10px;margin-bottom:10px;border-left:4px solid #667eea;transition:.3s}
    .meeting-item:hover{transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .meeting-time{font-size:14px;font-weight:600;color:#666;margin-bottom:5px}
    .meeting-title{font-size:16px;font-weight:600;color:#333;margin-bottom:5px}
    .meeting-detail{font-size:13px;color:#666}
    .chat-container{height:300px;overflow-y:auto;padding:15px;background:#f8f9fa;border-radius:10px;margin-bottom:15px}
    .chat-message{margin-bottom:15px;padding:10px;background:#fff;border-radius:10px}
    .chat-message.sent{background:#667eea;color:#fff;margin-left:20%}
    .chat-message.received{margin-right:20%}
    .chat-time{font-size:11px;opacity:.7;margin-top:5px}
    .chat-input-group{display:flex;gap:10px}
    .chat-input{flex:1;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    .file-upload-area{border:2px dashed #ddd;border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:.3s}
    .file-upload-area:hover{border-color:#667eea;background:#f8f9fa}
    .file-list{margin-top:15px;max-height:200px;overflow-y:auto}
    .file-item{display:flex;align-items:center;gap:10px;padding:8px;background:#f8f9fa;border-radius:8px;margin-bottom:8px}
    .request-list{max-height:300px;overflow-y:auto}
    .request-item{padding:12px;background:#f8f9fa;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .request-status{padding:5px 10px;border-radius:5px;font-size:12px;font-weight:600}
    .status-open{background:#fef3c7;color:#d97706}
    .status-doing{background:#dbeafe;color:#2563eb}
    .status-done{background:#d1fae5;color:#059669}
    .meeting-item.completed{opacity:.6;background:#e8e8e8}
    .meeting-item.ongoing{background:#fff8e1;border-left-color:#ff9800;animation:pulse-border 2s infinite}
    @keyframes pulse-border{0%,100%{border-left-width:4px}50%{border-left-width:6px}}
    .meeting-item.upcoming{background:#e8f5e9;border-left-color:#4caf50}
    .chat-message.schedule-request{background:#fff3e0!important;color:#333!important;border:1px solid #ff9800}
    .toast{position:fixed;top:20px;right:20px;padding:15px 20px;background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.2);display:none;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.show{display:flex;align-items:center;gap:10px}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
      <div class="status-bar">
        <div class="status-item"><div class="status-dot"></div><span>ì‹¤ì‹œê°„ ë™ê¸°í™”</span></div>
        <div class="status-item"><span>ğŸ“… <span id="currentDate"></span></span></div>
        <div class="status-item"><span>â° <span id="currentTime"></span></span></div>
        <div class="status-item">
          <span>ğŸ‘¤ <select id="userRole" onchange="switchUserRole()" style="padding:2px 5px;border-radius:4px;">
            <option value="secretary">ë¹„ì„œ ëª¨ë“œ</option>
            <option value="ceo">ëŒ€í‘œë‹˜ ëª¨ë“œ</option>
          </select></span>
        </div>
        <div class="status-item"><span>ğŸ“Œ ì—´ë¦° ìš”ì²­: <strong id="openRequests">0</strong>ê±´</span></div>
      </div>
    </div>

    <!-- ê¸´ê¸‰/ì„œëª…/ì˜ˆì•½ ì…ë ¥ íŒ¨ë„ -->
    <div class="urgent-panel">
      <h3 style="margin-bottom:15px;" id="panelTitle">ğŸ“¤ ê¸´ê¸‰ ì „ë‹¬</h3>
      <div class="request-types">
        <button class="request-type-btn active" onclick="setRequestType('urgent', event)">ğŸš¨ ê¸´ê¸‰ ìš”ì²­</button>
        <button class="request-type-btn" id="signBtn" onclick="setRequestType('sign', event)">âœï¸ ì„œëª… ìš”ì²­</button>
        <button class="request-type-btn" onclick="setRequestType('reserve', event)">ğŸ“… ì˜ˆì•½/ì¼ì •</button>
      </div>
      <div style="background:rgba(255,255,255,.2);padding:10px;border-radius:8px;margin:10px 0;font-size:13px;">
        ğŸ’¡ <strong>í˜„ì¬:</strong> <span id="currentUserDisplay">ë¹„ì„œ ëª¨ë“œ</span>
        <div id="reserveGuide" style="display:none;margin-top:5px;padding-top:5px;border-top:1px solid rgba(255,255,255,.3);">
          ğŸ“… <strong>ì˜ˆì•½/ì¼ì • ì‚¬ìš©ë²•:</strong><br/>
          â€¢ ëŒ€í‘œë‹˜: ì˜ˆì•½ ìš”ì²­ ì…ë ¥ (ì˜ˆ: "ë‚´ì¼ 3ì‹œ Aì‚¬ ë¯¸íŒ… ì¡ì•„ì£¼ì„¸ìš”")<br/>
          â€¢ ë¹„ì„œ: ì˜ˆì•½ ì™„ë£Œ í›„ ê²°ê³¼ ì…ë ¥ (ì˜ˆ: "Aì‚¬ ë¯¸íŒ… 15ì‹œ í™•ì •")
        </div>
      </div>
      <textarea class="message-input" id="urgentMessage" placeholder="ê¸´ê¸‰í•˜ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <div class="action-buttons">
        <button class="btn btn-send" onclick="sendRequest()">
          <span>ğŸ“¤</span><span id="sendButtonText">ìŠ¬ë™ëŒ€ì‹œë³´ë“œë´‡ìœ¼ë¡œ ì „ì†¡</span>
        </button>
      </div>
    </div>

    <div class="main-grid">
      <div>
        <!-- ì˜¤ëŠ˜ì˜ ë¯¸íŒ… -->
        <div class="card" style="margin-bottom:25px;">
          <div class="card-header">
            <div class="card-title">ğŸ“… ì˜¤ëŠ˜ì˜ ë¯¸íŒ…</div>
            <div style="display:flex;align-items:center;gap:10px;">
              <span class="badge" id="meetingCount">0ê±´</span>
              <span style="font-size:12px;color:#999;">ğŸ’œ ìŠ¬ë™ #ë¯¸íŒ…-í˜„í™©</span>
            </div>
          </div>
          <div class="meeting-list" id="meetingList">
            <div style="text-align:center;color:#999;">ìŠ¬ë™ ì±„ë„ì—ì„œ ë¯¸íŒ… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
          <div style="margin-top:10px;padding:10px;background:#f0f0f0;border-radius:8px;font-size:12px;color:#666;">ğŸ’¡ ë¯¸íŒ… ì •ë³´ëŠ” ìŠ¬ë™ #ë¯¸íŒ…-í˜„í™© ì±„ë„ì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤</div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ì±„íŒ… (ë¡œì»¬ ì €ì¥) -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’¬ ëŒ€ì‹œë³´ë“œ ì±„íŒ…</div>
            <span class="badge">ì‹¤ì‹œê°„</span>
          </div>
          <div style="background:#f0f8ff;padding:10px;border-radius:8px;margin-bottom:15px;font-size:13px;">ğŸ“Œ <strong>ëŒ€í™” ë‚´ì—­:</strong> ëŒ€ì‹œë³´ë“œì—ì„œ ì´ë£¨ì–´ì§„ ëŒ€í™”ë§Œ í‘œì‹œë©ë‹ˆë‹¤ (ë³´ê´€: ìµœê·¼ 7ì¼)</div>
          <div class="chat-container" id="chatContainer"><div style="text-align:center;color:#999;">ëŒ€í™” ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
          <div class="chat-input-group">
            <input type="text" class="chat-input" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥â€¦" onkeypress="if(event.key==='Enter') sendChat()" />
            <button class="btn btn-send" onclick="sendChat()" style="padding:10px 20px;">ì „ì†¡</button>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: íŒŒì¼ & ìš”ì²­ -->
      <div>
        <!-- íŒŒì¼ ì—…ë¡œë“œ (Drive ê³µìœ ) -->
        <div class="card" style="margin-bottom:25px;">
          <div class="card-header"><div class="card-title">ğŸ“ íŒŒì¼ ê³µìœ </div></div>
          <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
            <div>ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
            <div style="font-size:12px;color:#999;margin-top:5px;">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸</div>
          </div>
          <input type="file" id="fileInput" style="display:none;" onchange="handleFileSelect(event)" />
          <div class="file-list" id="fileList"></div>
        </div>

        <!-- ì—…ë¬´ ì§€ì‹œ / ìš”ì²­ í˜„í™© -->
        <div class="card">
          <div class="card-header"><div class="card-title">ğŸ§­ ì—…ë¬´ ì§€ì‹œ</div></div>
          <div class="request-list" id="requestList"><div style="text-align:center;color:#999;">ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastIcon">âœ…</span><span id="toastMessage">ë©”ì‹œì§€</span></div>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      GAS_URL: 'https://script.google.com/a/macros/cafe24corp.com/s/AKfycbxKdSjsv-9Nn8rH-MG1A4KXmUsqoeAAOe8T9EjrnNKQgX9M1-DrswWZANq0AcgTmwiSPA/exec', // ì‹¤ì œ ë°°í¬ URL
      TOKEN: '7c1e4a9fdb2e4930b58c6e91d7a4b235',
      AUTO_REFRESH: 30000,
      MEETING_REFRESH: 60000
    };

    let currentRequestType = 'urgent';
    let selectedFile = null;
    let currentUser = localStorage.getItem('userRole') || 'secretary';
    // ìµœê·¼ ì—…ë¡œë“œ íŒŒì¼(ìë™ í¬í•¨ìš©)
    let lastUploaded = null;

    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('userRole').value = currentUser;
      updateUserInterface();
      updateDateTime();
      syncMeetingsFromSlack();
      loadMeetings();
      loadChatHistory();
      countOpenRequests();
      loadRecentRequests();

      setInterval(() => {
        loadChatHistory();
        countOpenRequests();
        loadRecentRequests();
        // ìš”ì²­ ìƒíƒœì˜ ìŠ¬ë™ ë¦¬ì•¡ì…˜ ë™ê¸°í™” (ğŸ‘€/âœ…)
        callGAS('GET','requests/refresh').catch(()=>{});
      }, CONFIG.AUTO_REFRESH);

      setInterval(() => {
        syncMeetingsFromSlack();
        loadMeetings();
      }, CONFIG.MEETING_REFRESH);

      setInterval(updateDateTime, 1000);
    });

   // ===== JSONP ONLY callGAS =====
  function callGAS(method, path, data = {}) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Date.now() + '_' + Math.floor(Math.random() * 1e9);
      let settled = false;

      // ê³µí†µ ì •ë¦¬ í•¨ìˆ˜
      function cleanup() {
        try { delete window[cb]; } catch(_) {}
        try { if (script && script.parentNode) script.parentNode.removeChild(script); } catch(_) {}
      }

      const timeout = setTimeout(() => {
        if (settled) return;
        settled = true;
        cleanup();
        reject(new Error('Request timeout'));
      }, 30000);

      window[cb] = (res) => {
        if (settled) return;
        settled = true;
        clearTimeout(timeout);
        cleanup();
        resolve(res);
      };

      let url = `${CONFIG.GAS_URL}?path=${encodeURIComponent(path)}&token=${encodeURIComponent(CONFIG.TOKEN)}&callback=${cb}`;
      if (method === 'POST') {
        url += `&method=POST&body=${encodeURIComponent(JSON.stringify(data))}`;
      }

      const script = document.createElement('script');
      script.src = url;
      script.onerror = () => {
        if (settled) return;
        settled = true;
        clearTimeout(timeout);
        cleanup();
        reject(new Error('Script load error'));
      };
      document.body.appendChild(script);
    });
  }
    
    // ===== Utils =====
    function showToast(icon, msg){ const t=document.getElementById('toast'); document.getElementById('toastIcon').textContent=icon; document.getElementById('toastMessage').textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    function updateDateTime(){ const now=new Date(); document.getElementById('currentDate').textContent=now.toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'}); document.getElementById('currentTime').textContent=now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}); }

    // 1899 ë°©ì§€: HH:mmë¡œ ì •ê·œí™”
    function toHHMM(t){ if(!t) return ''; if(typeof t==='string'){ const m=t.match(/(\d{1,2}):(\d{2})/); return m ? m[1].padStart(2,'0')+':'+m[2] : t; } try{ const d=new Date(t); if(!isNaN(d)) return d.toTimeString().slice(0,5); }catch(_){} return String(t); }

    // ===== UI =====
    function switchUserRole(){ currentUser=document.getElementById('userRole').value; localStorage.setItem('userRole', currentUser); updateUserInterface(); showToast('ğŸ‘¤', `${currentUser==='ceo'?'ëŒ€í‘œë‹˜':'ë¹„ì„œ'} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤`); }
    function updateUserInterface(){ const isCEO=currentUser==='ceo'; document.getElementById('panelTitle').textContent=isCEO?'ğŸ“¤ ë¹„ì„œì—ê²Œ ì „ë‹¬':'ğŸ“¤ ëŒ€í‘œë‹˜ê»˜ ì „ë‹¬'; document.getElementById('currentUserDisplay').textContent=isCEO?'ëŒ€í‘œë‹˜ ëª¨ë“œ':'ë¹„ì„œ ëª¨ë“œ'; document.getElementById('sendButtonText').textContent=isCEO?'ë¹„ì„œì—ê²Œ ì „ì†¡ (ìŠ¬ë™ëŒ€ì‹œë³´ë“œë´‡)':'ëŒ€í‘œë‹˜ê»˜ ì „ì†¡ (ìŠ¬ë™ëŒ€ì‹œë³´ë“œë´‡)'; document.getElementById('urgentMessage').placeholder=isCEO?'ë¹„ì„œì—ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...':'ëŒ€í‘œë‹˜ê»˜ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...'; const signBtn=document.getElementById('signBtn'); if(isCEO){signBtn.style.opacity='0.5';signBtn.style.cursor='not-allowed';signBtn.disabled=true;}else{signBtn.style.opacity='1';signBtn.style.cursor='pointer';signBtn.disabled=false;} }
    function setRequestType(type, ev){ if(currentUser==='ceo' && type==='sign'){ showToast('âš ï¸','ì„œëª… ìš”ì²­ì€ ë¹„ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤'); return;} currentRequestType=type; document.querySelectorAll('.request-type-btn').forEach(btn=>btn.classList.remove('active')); if(ev && ev.target) ev.target.classList.add('active'); document.getElementById('reserveGuide').style.display = (type==='reserve'?'block':'none'); }

    // ===== Meetings =====
    async function syncMeetingsFromSlack(){ try{ const r=await callGAS('GET','meetings/refresh'); if (r.inserted>0 || r.removed>0) showToast('ğŸ“…',`ë¯¸íŒ… ì—…ë°ì´íŠ¸: ${r.inserted} ì¶”ê°€, ${r.removed} ì œê±°`); await loadMeetings(); }catch(e){ console.error('ìŠ¬ë™ ë¯¸íŒ… ë™ê¸°í™” ì‹¤íŒ¨:', e);} }
    async function loadMeetings(){ try{ const data=await callGAS('GET','meetings/list'); const list=document.getElementById('meetingList'); const items=data.items||[]; document.getElementById('meetingCount').textContent=items.length+'ê±´'; if(items.length===0){list.innerHTML='<div style="text-align:center;color:#999;">ì˜¤ëŠ˜ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>';return} items.sort((a,b)=> toHHMM(a.start_time).localeCompare(toHHMM(b.start_time)) ); const now=new Date(); const curMin=now.getHours()*60+now.getMinutes(); list.innerHTML=items.map(m=>{ const hhmm=toHHMM(m.start_time); let status='',cls=''; if(hhmm){ const [h,mi]=hhmm.split(':').map(Number); const mt=h*60+mi; if(mt<curMin-60){status='âœ… ì™„ë£Œ';cls='completed'} else if(Math.abs(mt-curMin)<30){status='ğŸ”„ ì§„í–‰ì¤‘';cls='ongoing'} else if(mt>curMin){status='â° ì˜ˆì •';cls='upcoming'} } return `<div class="meeting-item ${cls}"><div class="meeting-time">${hhmm||'ì‹œê°„ ë¯¸ì •'} ${status}</div><div class="meeting-title">${m.title||''}</div><div class="meeting-detail">ğŸ“ ${m.location||'ì¥ì†Œ ë¯¸ì •'} ${m.link?`| <a href="${m.link}" target="_blank">ğŸ”— ë§í¬</a>`:''}</div></div>` }).join(''); }catch(e){ console.error('ë¯¸íŒ… ë¡œë“œ ì‹¤íŒ¨:', e);} }

    // ===== Dashboard Chat (Local) =====
    async function loadChatHistory(){ try{ const data=await callGAS('GET','chat/local/history'); const container=document.getElementById('chatContainer'); const items=data.items||[]; if(items.length===0){ container.innerHTML='<div style="text-align:center;color:#999;">ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; } container.innerHTML=items.map(msg=>{ const mine=(msg.from===currentUser); const klass=mine?'sent':'received'; const ts=new Date(msg.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}); return `<div class="chat-message ${klass}"><div>${msg.text||''}</div><div class="chat-time">${ts}</div></div>`; }).join(''); container.scrollTop=container.scrollHeight; }catch(err){ console.error('ëŒ€ì‹œë³´ë“œ ì±„íŒ… ë¡œë“œ ì‹¤íŒ¨:', err); } }
    async function sendChat(){ const input=document.getElementById('chatInput'); const text=input.value.trim(); if(!text) return; try{ input.disabled=true; await callGAS('POST','chat/local/send',{from:currentUser, text}); input.value=''; setTimeout(loadChatHistory,300); }catch(err){ showToast('âŒ','ì „ì†¡ ì‹¤íŒ¨'); }finally{ input.disabled=false; input.focus(); } }

    // ===== Requests =====
    async function countOpenRequests(){ try{ const d=await callGAS('GET','requests/count'); document.getElementById('openRequests').textContent=d.open||0; }catch(e){ console.error('ìš”ì²­ ìˆ˜ í™•ì¸ ì‹¤íŒ¨:', e);} }
    async function loadRecentRequests(){ try{ const d=await callGAS('GET','requests/list'); const list=document.getElementById('requestList'); const items=d.items||[]; if(items.length===0){ list.innerHTML='<div style="text-align:center;color:#999;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; } list.innerHTML=items.slice(0,12).map(req=>{ let icon='ğŸ“Œ'; if(req.type==='urgent') icon='ğŸš¨'; else if(req.type==='sign') icon='âœï¸'; else if(req.type==='reserve') icon='ğŸ“…'; else if(req.type==='task') icon='ğŸ§­'; let statusClass='status-open', statusLabel='ëŒ€ê¸°'; if(req.status==='doing'){ statusClass='status-doing'; statusLabel='í™•ì¸'; } else if(req.status==='done'){ statusClass='status-done'; statusLabel='ì™„ë£Œ'; } const time=new Date(req.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}); const from=req.from==='ceo'?'ğŸ‘¤ ëŒ€í‘œë‹˜':'ğŸ‘©â€ğŸ’¼ ë¹„ì„œ'; const title=(req.message||'').substring(0,30)+((req.message&&req.message.length>30)?'...':''); return `<div class="request-item"><div><div style="font-weight:600;">${icon} ${title}</div><div style="font-size:12px;color:#999;margin-top:5px;">${from} â€¢ ${time}</div></div><span class="request-status ${statusClass}">${statusLabel}</span></div>`; }).join(''); }catch(e){ console.error('ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', e);} }
    async function sendRequest(){
      const textarea = document.getElementById('urgentMessage');
      const message = textarea.value.trim();
      if(!message){
        showToast('âš ï¸','ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
      }
      try{
        showToast('â³','ì „ì†¡ ì¤‘...');
        await callGAS('POST','requests/create',{
          type: currentRequestType,
          from: currentUser,
          message,
          priority: currentRequestType==='urgent' ? 'high' : 'normal'
        });
        textarea.value = '';
        const recipient = currentUser==='ceo' ? 'ë¹„ì„œ' : 'ëŒ€í‘œë‹˜';
        showToast('âœ…', `${recipient}ì—ê²Œ ìŠ¬ë™ëŒ€ì‹œë³´ë“œë´‡ìœ¼ë¡œ ì „ì†¡ ì™„ë£Œ!`);
        countOpenRequests();
        loadRecentRequests();
        setTimeout(loadChatHistory, 800);
      }catch(err){
        showToast('âŒ','ì „ì†¡ ì‹¤íŒ¨: '+err.message);
      }
    }

    
    <!-- ===== Files (Drive upload) ===== -->
     function handleFileSelect(ev){
      const file = ev.target.files[0];
      if(!file) return;
      selectedFile = file;
      document.getElementById('fileList').innerHTML = `
        <div class="file-item">
          <span>ğŸ“„</span><span>${file.name}</span>
          <button onclick="uploadSelectedFile()" class="btn" style="padding:5px 10px;font-size:12px;">ì—…ë¡œë“œ</button>
        </div>`;
    }
    
   
    const LARGE_THRESHOLD = 100 * 1024; // 100KB ì´ìƒì€ POST(no-cors) ê²½ë¡œ

    async function uploadSelectedFile(){
      if(!selectedFile) return;

      try{
        showToast('â³','íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = e.target.result.split(',')[1];
          const payload = {
            filename: selectedFile.name,
            mimeType: selectedFile.type || 'application/octet-stream',
            base64,
            uploaded_by: currentUser
          };

          // ê³ ìœ  ì‹ë³„ì(í´ë§ì—ì„œ ì°¾ê¸° ìœ„í•¨)
          const upid = 'UP-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
          payload.related_request_id = upid;

          let url = null;

          if (selectedFile.size <= LARGE_THRESHOLD) {
            // --- ì‘ì€ íŒŒì¼: JSONPë¡œ ë°”ë¡œ ì—…ë¡œë“œ ---
            const result = await callGAS('POST','files/upload', payload);
            if(!result || result.ok === false || !result.url){
              console.error('upload failed(JSONP)', result);
              showToast('âŒ','ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result && result.error ? result.error : 'ì„œë²„ ì‘ë‹µ ì—†ìŒ'));
              return;
            }
            url = result.url;

          } else {
            // --- í° íŒŒì¼: ì§„ì§œ POST(no-cors) ë³´ë‚´ê³  â†’ listë¥¼ í´ë§ ---
            try{
              await fetch(`${CONFIG.GAS_URL}?path=files/upload`, {
                method: 'POST',
                mode: 'no-cors',                // ì‘ë‹µì€ ëª» ì½ì§€ë§Œ ì„œë²„ì—ëŠ” ì „ë‹¬ë¨
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({...payload, token: CONFIG.TOKEN}) // _auth í†µê³¼
              });
            }catch(_){ /* no-corsë¼ ì—ëŸ¬ ë¬´ì‹œ */ }

            // ì—…ë¡œë“œ ë°˜ì˜ë  ë•Œê¹Œì§€ files/listë¡œ í´ë§(ìµœëŒ€ 10ì´ˆ)
            const started = Date.now();
            while(Date.now() - started < 10000){ // 10ì´ˆ
              await new Promise(r=>setTimeout(r, 1200));
              const data = await callGAS('GET','files/list');
              const items = (data && data.items) ? data.items : [];
              const hit = items.find(it => it.related === upid);
              if (hit && hit.url) { url = hit.url; break; }
            }
            if(!url){
              showToast('âŒ','ì—…ë¡œë“œ í™•ì¸ ì‹¤íŒ¨(ì‹œê°„ì´ˆê³¼)');
              return;
            }
          }

          // ì„±ê³µ ì²˜ë¦¬
          showToast('âœ…','íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!');
          const ta = document.getElementById('urgentMessage');
          const line = `\nğŸ“ íŒŒì¼: ${url}`;
          if(!ta.value.includes(url)) ta.value += line;

          document.getElementById('fileList').innerHTML = '';
          selectedFile = null;
          if (typeof loadSharedFiles === 'function') loadSharedFiles();
        };
        reader.readAsDataURL(selectedFile);

      }catch(err){
        console.error('upload error', err);
        showToast('âŒ','ì—…ë¡œë“œ ì‹¤íŒ¨');
      }
    }
    </script>
    </body>
    </html>
