<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€í‘œë‹˜ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .badge {
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ê¸´ê¸‰ ìš”ì²­ íŒ¨ë„ */
        .urgent-panel {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .request-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .request-type-btn {
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .request-type-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .message-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-send {
            background: white;
            color: #ea580c;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* ë¯¸íŒ… ë¦¬ìŠ¤íŠ¸ */
        .meeting-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .meeting-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .meeting-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .meeting-time {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .meeting-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .meeting-detail {
            font-size: 13px;
            color: #666;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-container {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }

        .chat-message.sent {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .chat-message.received {
            margin-right: 20%;
        }

        .chat-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ */
        .file-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* ìš”ì²­ ìƒíƒœ */
        .request-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .request-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-open {
            background: #fef3c7;
            color: #d97706;
        }

        .status-doing {
            background: #dbeafe;
            color: #2563eb;
        }

        .status-done {
            background: #d1fae5;
            color: #059669;
        }

        /* ë¯¸íŒ… ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
        .meeting-item.completed {
            opacity: 0.6;
            background: #e8e8e8;
        }

        .meeting-item.ongoing {
            background: #fff8e1;
            border-left-color: #ff9800;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-left-width: 4px; }
            50% { border-left-width: 6px; }
        }

        .meeting-item.upcoming {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        /* ì¼ì • ìš”ì²­ ë©”ì‹œì§€ í•˜ì´ë¼ì´íŠ¸ */
        .chat-message.schedule-request {
            background: #fff3e0 !important;
            color: #333 !important;
            border: 1px solid #ff9800;
        }

        /* ì•Œë¦¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ë¡œë”© */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ì‹¤ì‹œê°„ ë™ê¸°í™”</span>
                </div>
                <div class="status-item">
                    <span>ğŸ“… <span id="currentDate"></span></span>
                </div>
                <div class="status-item">
                    <span>â° <span id="currentTime"></span></span>
                </div>
                <div class="status-item">
                    <span>ğŸ‘¤ <select id="userRole" onchange="switchUserRole()" style="padding: 2px 5px; border-radius: 4px;">
                        <option value="secretary">ë¹„ì„œ ëª¨ë“œ</option>
                        <option value="ceo">ëŒ€í‘œë‹˜ ëª¨ë“œ</option>
                    </select></span>
                </div>
                <div class="status-item">
                    <span>ğŸ“Œ ì—´ë¦° ìš”ì²­: <strong id="openRequests">0</strong>ê±´</span>
                </div>
            </div>
        </div>

        <!-- ê¸´ê¸‰ ìš”ì²­ íŒ¨ë„ -->
        <div class="urgent-panel">
            <h3 style="margin-bottom: 15px;" id="panelTitle">ğŸ“¤ ê¸´ê¸‰ ì „ë‹¬</h3>
            
            <div class="request-types">
                <button class="request-type-btn active" onclick="setRequestType('urgent')">
                    ğŸš¨ ê¸´ê¸‰ ìš”ì²­
                </button>
                <button class="request-type-btn" id="signBtn" onclick="setRequestType('sign')">
                    âœï¸ ì„œëª… ìš”ì²­
                </button>
                <button class="request-type-btn" onclick="setRequestType('reserve')">
                    ğŸ“… ì˜ˆì•½/ì¼ì •
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px;">
                ğŸ’¡ <strong>í˜„ì¬:</strong> <span id="currentUserDisplay">ë¹„ì„œ ëª¨ë“œ</span>
                <div id="reserveGuide" style="display: none; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.3);">
                    ğŸ“… <strong>ì˜ˆì•½/ì¼ì • ì‚¬ìš©ë²•:</strong><br>
                    â€¢ ëŒ€í‘œë‹˜: ì˜ˆì•½ ìš”ì²­ ì…ë ¥ (ì˜ˆ: "ë‚´ì¼ 3ì‹œ Aì‚¬ ë¯¸íŒ… ì¡ì•„ì£¼ì„¸ìš”")<br>
                    â€¢ ë¹„ì„œ: ì˜ˆì•½ ì™„ë£Œ í›„ ê²°ê³¼ ì…ë ¥ (ì˜ˆ: "Aì‚¬ ë¯¸íŒ… 15ì‹œ í™•ì •")
                </div>
            </div>
            
            <textarea class="message-input" id="urgentMessage" 
                placeholder="ê¸´ê¸‰í•˜ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            
            <div class="action-buttons">
                <button class="btn btn-send" onclick="sendRequest()">
                    <span>ğŸ“¤</span>
                    <span id="sendButtonText">ìŠ¬ë™ DMìœ¼ë¡œ ì „ì†¡</span>
                </button>
                <button class="btn btn-send" onclick="uploadFile()">
                    <span>ğŸ“</span>
                    <span>íŒŒì¼ ì²¨ë¶€</span>
                </button>
            </div>
        </div>: 11px; opacity: 0.8; margin-top: 3px;">ë¹„ì„œâ†’ëŒ€í‘œë‹˜</div>
                </button>
                <button class="request-type-btn" style="opacity: 0.5; cursor: not-allowed;">
                    ğŸ“… ì˜ˆì•½/ì¼ì •
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 3px;">ëŒ€í‘œë‹˜â†’ë¹„ì„œ (DM)</div>
                </button>
            </div>
            
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px;">
                ğŸ’¡ <strong>ì‚¬ìš©ë²•:</strong> ë¹„ì„œë‹˜ì´ ëŒ€í‘œë‹˜ê»˜ ê¸´ê¸‰íˆ ì•Œë ¤ì•¼ í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”
            </div>
            
            <textarea class="message-input" id="urgentMessage" 
                placeholder="ì˜ˆ: ì§€ê¸ˆ ì„œëª…ì´ í•„ìš”í•©ë‹ˆë‹¤ / íˆ¬ììê°€ ê¸´ê¸‰ ë¯¸íŒ… ìš”ì²­ / ê³„ì•½ì„œ ë§ˆê° ì„ë°•..."></textarea>
            
            <div class="action-buttons">
                <button class="btn btn-send" onclick="sendRequest()">
                    <span>ğŸ“¤</span>
                    <span>ëŒ€í‘œë‹˜ê»˜ ì „ì†¡ (ìŠ¬ë™ DM)</span>
                </button>
                <button class="btn btn-send" onclick="uploadFile()">
                    <span>ğŸ“</span>
                    <span>íŒŒì¼ ì²¨ë¶€</span>
                </button>
            </div>
        </div>

        <div class="main-grid">
            <!-- ì™¼ìª½: ë¯¸íŒ… & ì±„íŒ… -->
            <div>
                <!-- ì˜¤ëŠ˜ì˜ ë¯¸íŒ… -->
                <div class="card" style="margin-bottom: 25px;">
                    <div class="card-header">
                        <div class="card-title">ğŸ“… ì˜¤ëŠ˜ì˜ ë¯¸íŒ…</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="badge" id="meetingCount">0ê±´</span>
                            <span style="font-size: 12px; color: #999;">ğŸ’œ ìŠ¬ë™ #ë¯¸íŒ…-í˜„í™©</span>
                        </div>
                    </div>
                    <div class="meeting-list" id="meetingList">
                        <div style="text-align: center; color: #999;">
                            ìŠ¬ë™ ì±„ë„ì—ì„œ ë¯¸íŒ… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 8px; font-size: 12px; color: #666;">
                        ğŸ’¡ ë¯¸íŒ… ì •ë³´ëŠ” ìŠ¬ë™ #ë¯¸íŒ…-í˜„í™© ì±„ë„ì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤
                    </div>
                </div>

                <!-- ìŠ¬ë™ DM ì±„íŒ… -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ’¬ ìŠ¬ë™ DM ëŒ€í™”</div>
                        <span class="badge">ì‹¤ì‹œê°„</span>
                    </div>
                    
                    <div style="background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
                        ğŸ“Œ <strong>ëŒ€í™” ë‚´ì—­:</strong> ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ì™€ ìŠ¬ë™ DM ëŒ€í™”ê°€ ëª¨ë‘ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                    
                    <div class="chat-container" id="chatContainer">
                        <div style="text-align: center; color: #999;">
                            ëŒ€í™” ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                    <div class="chat-input-group">
                        <input type="text" class="chat-input" id="chatInput" 
                            placeholder="ë¹ ë¥¸ ë‹µë³€ ì…ë ¥..." 
                            onkeypress="if(event.key==='Enter') sendChat()">
                        <button class="btn btn-send" onclick="sendChat()" style="padding: 10px 20px;">
                            ì „ì†¡
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: íŒŒì¼ & ìš”ì²­ -->
            <div>
                <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                <div class="card" style="margin-bottom: 25px;">
                    <div class="card-header">
                        <div class="card-title">ğŸ“ íŒŒì¼ ê³µìœ </div>
                    </div>
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <div>ğŸ“ í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸
                        </div>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
                    <div class="file-list" id="fileList"></div>
                </div>

                <!-- ìš”ì²­ ìƒíƒœ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“‹ ìš”ì²­ í˜„í™©</div>
                    </div>
                    <div class="request-list" id="requestList">
                        <div style="text-align: center; color: #999;">
                            ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div class="toast" id="toast">
        <span id="toastIcon">âœ…</span>
        <span id="toastMessage">ë©”ì‹œì§€</span>
    </div>

    <script>
        // ì„¤ì •
        const CONFIG = {
            GAS_URL: 'https://script.google.com/a/macros/cafe24corp.com/s/AKfycbxKdSjsv-9Nn8rH-MG1A4KXmUsqoeAAOe8T9EjrnNKQgX9M1-DrswWZANq0AcgTmwiSPA/exec', // Google Apps Script URL
            TOKEN: '7c1e4a9fdb2e4930b58c6e91d7a4b235', // GASì˜ TOKENê³¼ ë™ì¼í•˜ê²Œ
            AUTO_REFRESH: 30000, // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
            MEETING_REFRESH: 60000 // 1ë¶„ë§ˆë‹¤ ë¯¸íŒ… ì •ë³´ ìƒˆë¡œê³ ì¹¨ (ìŠ¬ë™ ì±„ë„ì—ì„œ)
        };

        let currentRequestType = 'urgent';
        let selectedFile = null;
        let currentUser = localStorage.getItem('userRole') || 'secretary';

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì‚¬ìš©ì ëª¨ë“œ ë³µì›
            document.getElementById('userRole').value = currentUser;
            updateUserInterface();
            
            updateDateTime();
            syncMeetingsFromSlack(); // ìŠ¬ë™ ì±„ë„ì—ì„œ ë¯¸íŒ… ì •ë³´ ë™ê¸°í™”
            loadMeetings();
            loadChatHistory();
            countOpenRequests();
            loadRecentRequests(); // ìµœê·¼ ìš”ì²­ ë‚´ì—­ ë¡œë“œ
            
            // ìë™ ìƒˆë¡œê³ ì¹¨
            setInterval(() => {
                loadChatHistory();
                countOpenRequests();
                loadRecentRequests();
            }, CONFIG.AUTO_REFRESH);
            
            // ë¯¸íŒ… ì •ë³´ëŠ” 1ë¶„ë§ˆë‹¤ ìŠ¬ë™ì—ì„œ ë™ê¸°í™”
            setInterval(() => {
                syncMeetingsFromSlack();
                loadMeetings();
            }, CONFIG.MEETING_REFRESH);
            
            // ì‹œê°„ ì—…ë°ì´íŠ¸
            setInterval(updateDateTime, 1000);
        });

        // ì‚¬ìš©ì ì—­í•  ì „í™˜
        function switchUserRole() {
            currentUser = document.getElementById('userRole').value;
            localStorage.setItem('userRole', currentUser);
            updateUserInterface();
            showToast('ğŸ‘¤', `${currentUser === 'ceo' ? 'ëŒ€í‘œë‹˜' : 'ë¹„ì„œ'} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤`);
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUserInterface() {
            const isCEO = currentUser === 'ceo';
            
            // íŒ¨ë„ ì œëª© ë³€ê²½
            document.getElementById('panelTitle').textContent = 
                isCEO ? 'ğŸ“¤ ë¹„ì„œì—ê²Œ ì „ë‹¬' : 'ğŸ“¤ ëŒ€í‘œë‹˜ê»˜ ì „ë‹¬';
            
            // í˜„ì¬ ì‚¬ìš©ì í‘œì‹œ
            document.getElementById('currentUserDisplay').textContent = 
                isCEO ? 'ëŒ€í‘œë‹˜ ëª¨ë“œ' : 'ë¹„ì„œ ëª¨ë“œ';
            
            // ì „ì†¡ ë²„íŠ¼ í…ìŠ¤íŠ¸
            document.getElementById('sendButtonText').textContent = 
                isCEO ? 'ë¹„ì„œì—ê²Œ ì „ì†¡ (ìŠ¬ë™ DM)' : 'ëŒ€í‘œë‹˜ê»˜ ì „ì†¡ (ìŠ¬ë™ DM)';
            
            // placeholder ë³€ê²½
            document.getElementById('urgentMessage').placeholder = 
                isCEO ? 'ë¹„ì„œì—ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...' 
                     : 'ëŒ€í‘œë‹˜ê»˜ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...';
            
            // ì„œëª… ìš”ì²­ ë²„íŠ¼ (ëŒ€í‘œë‹˜ì€ ì‚¬ìš© ì•ˆí•¨)
            const signBtn = document.getElementById('signBtn');
            if (isCEO) {
                signBtn.style.opacity = '0.5';
                signBtn.style.cursor = 'not-allowed';
                signBtn.disabled = true;
            } else {
                signBtn.style.opacity = '1';
                signBtn.style.cursor = 'pointer';
                signBtn.disabled = false;
            }
        }

        // ìš”ì²­ íƒ€ì… ì„¤ì •
        function setRequestType(type) {
            // ëŒ€í‘œë‹˜ì€ ì„œëª… ìš”ì²­ ë¶ˆê°€
            if (currentUser === 'ceo' && type === 'sign') {
                showToast('âš ï¸', 'ì„œëª… ìš”ì²­ì€ ë¹„ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            currentRequestType = type;
            document.querySelectorAll('.request-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ì˜ˆì•½/ì¼ì • ê°€ì´ë“œ í‘œì‹œ
            document.getElementById('reserveGuide').style.display = 
                type === 'reserve' ? 'block' : 'none';
        }

        // ë‚ ì§œ/ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'short' });
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        // ìš”ì²­ íƒ€ì… ì„¤ì •
        function setRequestType(type) {
            currentRequestType = type;
            document.querySelectorAll('.request-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // API í˜¸ì¶œ í—¬í¼
        async function callGAS(method, path, data = {}) {
            try {
                const url = `${CONFIG.GAS_URL}?path=${path}&token=${CONFIG.TOKEN}`;
        
                if (method === 'GET') {
                    // no-cors ëª¨ë“œ ì‚¬ìš©
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'no-cors'  // CORS ìš°íšŒ
                    });
            
                    // no-corsëŠ” ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ JSONP í´ë°±
                    return await callGAS_JSONP(method, path, data);
            
                } else {
                    // POSTë„ GETìœ¼ë¡œ ë³€í™˜
                    const postUrl = url + '&method=POST&body=' + encodeURIComponent(JSON.stringify(data));
                    return await callGAS_JSONP('GET', path, {method: 'POST', ...data});
                }
            } catch (err) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', err);
                // JSONPë¡œ ì¬ì‹œë„
                return await callGAS_JSONP(method, path, data);
            }
        }

        // JSONP í—¬í¼ í•¨ìˆ˜ ì¶”ê°€
        function callGAS_JSONP(method, path, data = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'callback_' + Date.now();
                const timeout = setTimeout(() => {
                    delete window[callbackName];
                    reject(new Error('Request timeout'));
                }, 10000);
        
                window[callbackName] = function(response) {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    document.body.removeChild(script);
                    resolve(response);
                };
        
                const script = document.createElement('script');
                let url = CONFIG.GAS_URL + '?path=' + path + '&token=' + CONFIG.TOKEN;
        
                if (method === 'POST') {
                    url += '&method=POST&body=' + encodeURIComponent(JSON.stringify(data));
                }
        
                url += '&callback=' + callbackName;
                script.src = url;
                script.onerror = () => {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    reject(new Error('Script load error'));
                };
        
                document.body.appendChild(script);
            });
        }

        // ìŠ¬ë™ ì±„ë„ì—ì„œ ë¯¸íŒ… ì •ë³´ ë™ê¸°í™”
        async function syncMeetingsFromSlack() {
            try {
                // refresh ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš© (ë®ì–´ì“°ê¸°)
                const result = await callGAS('GET', 'meetings/refresh');
                if (result.inserted > 0 || result.removed > 0) {
                    showToast('ğŸ“…', `ë¯¸íŒ… ì •ë³´ ì—…ë°ì´íŠ¸: ${result.inserted}ê°œ ì¶”ê°€, ${result.removed}ê°œ ì œê±°`);
                }
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMeetings();
            } catch (err) {
                console.error('ìŠ¬ë™ ë¯¸íŒ… ë™ê¸°í™” ì‹¤íŒ¨:', err);
            }
        }
        // ë¯¸íŒ… ëª©ë¡ ë¡œë“œ
        async function loadMeetings() {
            try {
                const data = await callGAS('GET', 'meetings/list');
                const list = document.getElementById('meetingList');
                const items = data.items || [];
                
                document.getElementById('meetingCount').textContent = items.length + 'ê±´';
                
                if (items.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: #999;">ì˜¤ëŠ˜ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                // ì‹œê°„ìˆœ ì •ë ¬
                items.sort((a, b) => (a.start_time || '').localeCompare(b.start_time || ''));
                
                // í˜„ì¬ ì‹œê°„ í™•ì¸
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                list.innerHTML = items.map(m => {
                    // ë¯¸íŒ… ìƒíƒœ íŒë‹¨
                    let status = '';
                    let statusClass = '';
                    if (m.start_time) {
                        const [hour, min] = m.start_time.split(':').map(Number);
                        const meetingTime = hour * 60 + min;
                        
                        if (meetingTime < currentTime - 60) {
                            status = 'âœ… ì™„ë£Œ';
                            statusClass = 'completed';
                        } else if (Math.abs(meetingTime - currentTime) < 30) {
                            status = 'ğŸ”„ ì§„í–‰ì¤‘';
                            statusClass = 'ongoing';
                        } else if (meetingTime > currentTime) {
                            status = 'â° ì˜ˆì •';
                            statusClass = 'upcoming';
                        }
                    }
                    
                    return `
                        <div class="meeting-item ${statusClass}">
                            <div class="meeting-time">${m.start_time || 'ì‹œê°„ ë¯¸ì •'} ${status}</div>
                            <div class="meeting-title">${m.title}</div>
                            <div class="meeting-detail">
                                ğŸ“ ${m.location || 'ì¥ì†Œ ë¯¸ì •'} | 
                                ğŸ‘¥ ${m.attendees || 'ì°¸ì„ì ë¯¸ì •'}
                                ${m.link ? `| <a href="${m.link}" target="_blank">ğŸ”— ë§í¬</a>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('ë¯¸íŒ… ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        // ì±„íŒ… ë‚´ì—­ ë¡œë“œ (ì–‘ë°©í–¥ ëŒ€í™”)
        async function loadChatHistory() {
            try {
                const data = await callGAS('GET', 'chat/history');
                const container = document.getElementById('chatContainer');
                const items = data.items || [];
                
                if (items.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999;">ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                container.innerHTML = items.map(msg => {
                    // ë´‡ì´ ë³´ë‚¸ ë©”ì‹œì§€ = ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€
                    const isSentByDashboard = msg.user === 'bot' || !msg.user;
                    
                    // ë©”ì‹œì§€ í‘œì‹œ ë°©í–¥ ê²°ì •
                    let messageClass = isSentByDashboard ? 'sent' : 'received';
                    let messageContent = msg.text;
                    
                    // ìš”ì²­ íƒ€ì… í‘œì‹œ
                    if (msg.text.includes('[ê¸´ê¸‰]')) {
                        messageContent = `ğŸš¨ ${msg.text}`;
                    } else if (msg.text.includes('[ì„œëª…ìš”ì²­]')) {
                        messageContent = `âœï¸ ${msg.text}`;
                    } else if (msg.text.includes('[ì˜ˆì•½]') || msg.text.includes('ì¼ì •') || msg.text.includes('ë¯¸íŒ…')) {
                        messageContent = `ğŸ“… ${msg.text}`;
                    }
                    
                    return `
                        <div class="chat-message ${messageClass}">
                            <div>${messageContent}</div>
                            <div class="chat-time">${new Date(parseFloat(msg.ts) * 1000).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    `;
                }).join('');
                
                container.scrollTop = container.scrollHeight;
            } catch (err) {
                console.error('ì±„íŒ… ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        // ì—´ë¦° ìš”ì²­ ìˆ˜ í™•ì¸
        async function countOpenRequests() {
            try {
                const data = await callGAS('GET', 'requests/count');
                document.getElementById('openRequests').textContent = data.open || 0;
            } catch (err) {
                console.error('ìš”ì²­ ìˆ˜ í™•ì¸ ì‹¤íŒ¨:', err);
            }
        }

        // ìµœê·¼ ìš”ì²­ ë‚´ì—­ ë¡œë“œ
        async function loadRecentRequests() {
            try {
                const data = await callGAS('GET', 'requests/list');
                const list = document.getElementById('requestList');
                const items = data.items || [];
                
                if (items.length === 0) {
                    list.innerHTML = '<div style="text-align: center; color: #999;">ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                list.innerHTML = items.slice(0, 10).map((req, idx) => {
                    let typeIcon = 'ğŸ“Œ';
                    if (req.type === 'urgent') typeIcon = 'ğŸš¨';
                    else if (req.type === 'sign') typeIcon = 'âœï¸';
                    else if (req.type === 'reserve') typeIcon = 'ğŸ“…';
                    
                    let statusClass = 'status-open';
                    if (req.status === 'doing') statusClass = 'status-doing';
                    else if (req.status === 'done') statusClass = 'status-done';
                    
                    return `
                        <div class="request-item">
                            <div>
                                <div style="font-weight: 600;">
                                    ${typeIcon} ${req.message.substring(0, 30)}${req.message.length > 30 ? '...' : ''}
                                </div>
                                <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                    ${req.from === 'ceo' ? 'ğŸ‘¤ ëŒ€í‘œë‹˜' : 'ğŸ‘©â€ğŸ’¼ ë¹„ì„œ'} â€¢ 
                                    ${new Date(req.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </div>
                            <span class="request-status ${statusClass}">
                                ${req.status === 'open' ? 'ëŒ€ê¸°' : req.status === 'doing' ? 'ì²˜ë¦¬ì¤‘' : 'ì™„ë£Œ'}
                            </span>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', err);
                // ìš”ì²­ ëª©ë¡ APIê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
            }
        }

        // ìš”ì²­ ì „ì†¡ (ì–‘ë°©í–¥)
        async function sendRequest() {
            const message = document.getElementById('urgentMessage').value.trim();
            if (!message) {
                showToast('âš ï¸', 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                showToast('â³', 'ì „ì†¡ ì¤‘...');
                
                // from í•„ë“œë¥¼ í˜„ì¬ ì‚¬ìš©ìì— ë”°ë¼ ì„¤ì •
                await callGAS('POST', 'requests/create', {
                    type: currentRequestType,
                    from: currentUser,  // 'secretary' ë˜ëŠ” 'ceo'
                    message: message,
                    priority: currentRequestType === 'urgent' ? 'high' : 'normal'
                });
                
                document.getElementById('urgentMessage').value = '';
                
                const recipient = currentUser === 'ceo' ? 'ë¹„ì„œ' : 'ëŒ€í‘œë‹˜';
                showToast('âœ…', `${recipient}ì—ê²Œ ìŠ¬ë™ DMìœ¼ë¡œ ì „ì†¡ ì™„ë£Œ!`);
                
                // ìš”ì²­ ìˆ˜ ì—…ë°ì´íŠ¸
                countOpenRequests();
                loadRecentRequests();
                
                // ì±„íŒ… ë‚´ì—­ë„ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadChatHistory, 1000);
            } catch (err) {
                showToast('âŒ', 'ì „ì†¡ ì‹¤íŒ¨: ' + err.message);
            }
        }

        // ì±„íŒ… ì „ì†¡
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            
            try {
                input.disabled = true;
                await callGAS('POST', 'chat/send', { text });
                input.value = '';
                
                // ì±„íŒ… ë‚´ì—­ ìƒˆë¡œê³ ì¹¨
                setTimeout(loadChatHistory, 1000);
            } catch (err) {
                showToast('âŒ', 'ì „ì†¡ ì‹¤íŒ¨');
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // íŒŒì¼ ì„ íƒ
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            const list = document.getElementById('fileList');
            list.innerHTML = `
                <div class="file-item">
                    <span>ğŸ“„</span>
                    <span>${file.name}</span>
                    <button onclick="uploadSelectedFile()" class="btn" style="padding: 5px 10px; font-size: 12px;">
                        ì—…ë¡œë“œ
                    </button>
                </div>
            `;
        }

        // íŒŒì¼ ì—…ë¡œë“œ
        async function uploadSelectedFile() {
            if (!selectedFile) return;
            
            try {
                showToast('â³', 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘...');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(',')[1];
                    
                    const result = await callGAS('POST', 'files/upload', {
                        filename: selectedFile.name,
                        mimeType: selectedFile.type,
                        base64: base64,
                        uploaded_by: 'secretary'
                    });
                    
                    showToast('âœ…', 'íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!');
                    
                    // íŒŒì¼ ë§í¬ë¥¼ ë©”ì‹œì§€ì— ì¶”ê°€
                    const message = document.getElementById('urgentMessage');
                    message.value += `\nğŸ“ íŒŒì¼: ${result.url}`;
                    
                    // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                    document.getElementById('fileList').innerHTML = '';
                    selectedFile = null;
                };
                reader.readAsDataURL(selectedFile);
            } catch (err) {
                showToast('âŒ', 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        function showToast(icon, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
