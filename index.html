<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>대표님 통합 대시보드</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#fff;border-radius:15px;padding:25px;margin-bottom:25px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header h1{font-size:28px;color:#333;margin-bottom:10px}
    .status-bar{display:flex;gap:20px;align-items:center}
    .status-item{display:flex;align-items:center;gap:8px;padding:8px 15px;background:#f0f0f0;border-radius:20px;font-size:14px}
    .status-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .main-grid{display:grid;grid-template-columns:2fr 1fr;gap:25px}
    @media (max-width:1024px){.main-grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
    .card-title{font-size:20px;font-weight:600;color:#333}
    .badge{padding:5px 12px;background:#667eea;color:#fff;border-radius:15px;font-size:12px;font-weight:600}
    .urgent-panel{background:linear-gradient(135deg,#f59e0b 0%,#ea580c 100%);color:#fff;border-radius:15px;padding:20px;margin-bottom:25px}
    .request-types{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px}
    .request-type-btn{padding:10px;background:rgba(255,255,255,.2);border:2px solid transparent;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:all .3s}
    .request-type-btn.active{background:rgba(255,255,255,.3);border-color:#fff}
    .message-input{width:100%;padding:15px;border:none;border-radius:10px;font-size:16px;margin-bottom:15px;resize:vertical;min-height:100px}
    .action-buttons{display:flex;gap:10px}
    .btn{padding:12px 25px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:8px}
    .btn-send{background:#fff;color:#ea580c}
    .btn-send:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .meeting-list{max-height:400px;overflow-y:auto}
    .meeting-item{padding:15px;background:#f8f9fa;border-radius:10px;margin-bottom:10px;border-left:4px solid #667eea;transition:all .3s}
    .meeting-item:hover{transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .meeting-time{font-size:14px;font-weight:600;color:#666;margin-bottom:5px}
    .meeting-title{font-size:16px;font-weight:600;color:#333;margin-bottom:5px}
    .meeting-detail{font-size:13px;color:#666}
    .chat-container{height:300px;overflow-y:auto;padding:15px;background:#f8f9fa;border-radius:10px;margin-bottom:15px}
    .chat-message{margin-bottom:15px;padding:10px;background:#fff;border-radius:10px}
    .chat-message.sent{background:#667eea;color:#fff;margin-left:20%}
    .chat-message.received{margin-right:20%}
    .chat-time{font-size:11px;opacity:.7;margin-top:5px}
    .chat-input-group{display:flex;gap:10px}
    .chat-input{flex:1;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    .request-list{max-height:420px;overflow-y:auto}
    .request-item{padding:12px;background:#f8f9fa;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .request-status{padding:5px 10px;border-radius:5px;font-size:12px;font-weight:600}
    .status-open{background:#fef3c7;color:#d97706}
    .status-doing{background:#dbeafe;color:#2563eb}
    .status-done{background:#d1fae5;color:#059669}
    .meeting-item.completed{opacity:.6;background:#e8e8e8}
    .meeting-item.ongoing{background:#fff8e1;border-left-color:#ff9800;animation:pulse-border 2s infinite}
    @keyframes pulse-border{0%,100%{border-left-width:4px}50%{border-left-width:6px}}
    .meeting-item.upcoming{background:#e8f5e9;border-left-color:#4caf50}
    .chat-message.schedule-request{background:#fff3e0!important;color:#333!important;border:1px solid #ff9800}
    .toast{position:fixed;top:20px;right:20px;padding:15px 20px;background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.2);display:none;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.show{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📊 통합 대시보드</h1>
      <div class="status-bar">
        <div class="status-item"><div class="status-dot"></div><span>실시간 동기화</span></div>
        <div class="status-item">📅 <span id="currentDate"></span></div>
        <div class="status-item">⏰ <span id="currentTime"></span></div>
        <div class="status-item">👤
          <select id="userRole" onchange="switchUserRole()" style="padding:2px 5px;border-radius:4px">
            <option value="secretary">비서 모드</option>
            <option value="ceo">대표님 모드</option>
          </select>
        </div>
        <div class="status-item">📌 열린 요청: <strong id="openRequests">0</strong>건</div>
      </div>
    </div>

    <!-- 긴급/서명/예약 패널 (파일첨부 제거) -->
    <div class="urgent-panel">
      <h3 style="margin-bottom:15px" id="panelTitle">📤 긴급 전달</h3>
      <div class="request-types">
        <button class="request-type-btn active" onclick="setRequestType(event,'urgent')">🚨 긴급 요청</button>
        <button class="request-type-btn" id="signBtn" onclick="setRequestType(event,'sign')">✍️ 서명 요청</button>
        <button class="request-type-btn" onclick="setRequestType(event,'reserve')">📅 예약/일정</button>
      </div>
      <div style="background:rgba(255,255,255,.2);padding:10px;border-radius:8px;margin:10px 0;font-size:13px">
        💡 <strong>현재:</strong> <span id="currentUserDisplay">비서 모드</span>
        <div id="reserveGuide" style="display:none;margin-top:5px;padding-top:5px;border-top:1px solid rgba(255,255,255,.3)">
          📅 <strong>예약/일정 사용법:</strong><br />
          • 대표님: 예약 요청 입력 (예: "내일 3시 A사 미팅 잡아주세요")<br />
          • 비서: 예약 완료 후 결과 입력 (예: "A사 미팅 15시 확정")
        </div>
      </div>
      <textarea class="message-input" id="urgentMessage" placeholder="긴급하게 전달할 내용을 입력하세요..."></textarea>
      <div class="action-buttons">
        <button class="btn btn-send" onclick="sendRequest()">
          <span>📤</span><span id="sendButtonText">슬랙 DM으로 전송</span>
        </button>
      </div>
    </div>

    <div class="main-grid">
      <div>
        <!-- 오늘의 미팅 -->
        <div class="card" style="margin-bottom:25px">
          <div class="card-header">
            <div class="card-title">📅 오늘의 미팅</div>
            <div style="display:flex;align-items:center;gap:10px">
              <span class="badge" id="meetingCount">0건</span>
              <span style="font-size:12px;color:#999">💜 슬랙 #미팅-현황</span>
            </div>
          </div>
          <div class="meeting-list" id="meetingList">
            <div style="text-align:center;color:#999">슬랙 채널에서 미팅 정보를 불러오는 중...</div>
          </div>
          <div style="margin-top:10px;padding:10px;background:#f0f0f0;border-radius:8px;font-size:12px;color:#666">
            💡 미팅 정보는 슬랙 #미팅-현황 채널에서 자동으로 가져옵니다 (매일 08:00/12:00)
          </div>
        </div>

        <!-- 슬랙 DM 대화 -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">💬 슬랙 DM 대화</div>
            <span class="badge">실시간</span>
          </div>
          <div style="background:#f0f8ff;padding:10px;border-radius:8px;margin-bottom:15px;font-size:13px">
            📌 <strong>대화 내역:</strong> 대시보드에서 보낸 메시지와 슬랙 DM 대화가 모두 표시됩니다
          </div>
          <div class="chat-container" id="chatContainer">
            <div style="text-align:center;color:#999">대화 내역을 불러오는 중...</div>
          </div>
          <div class="chat-input-group">
            <input type="text" class="chat-input" id="chatInput" placeholder="빠른 답변 입력..." onkeypress="if(event.key==='Enter') sendChat()" />
            <button class="btn btn-send" onclick="sendChat()" style="padding:10px 20px">전송</button>
          </div>
        </div>
      </div>

      <div>
        <!-- 업무 지시 (요청 현황 대체) -->
        <div class="card" style="margin-bottom:25px">
          <div class="card-header">
            <div class="card-title">🧭 업무 지시</div>
          </div>

          <!-- 대표님 모드에서만 입력창 노출 -->
          <div id="directiveInputWrap" style="display:none;margin-bottom:12px">
            <textarea class="message-input" id="directiveInput" placeholder="대표님 지시 사항을 입력하세요..."></textarea>
            <div class="action-buttons">
              <button class="btn btn-send" onclick="sendDirective()">🧭 지시 등록</button>
            </div>
          </div>

          <div class="request-list" id="requestList">
            <div style="text-align:center;color:#999">내역을 불러오는 중...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastIcon">✅</span><span id="toastMessage">메시지</span></div>

  <script>
    const CONFIG={
      GAS_URL:'https://script.google.com/a/macros/cafe24corp.com/s/AKfycbxKdSjsv-9Nn8rH-MG1A4KXmUsqoeAAOe8T9EjrnNKQgX9M1-DrswWZANq0AcgTmwiSPA/exec', // Apps Script 배포 URL
      TOKEN:'7c1e4a9fdb2e4930b58c6e91d7a4b235', // GAS TOKEN과 동일
      AUTO_REFRESH:30000 // 채팅/요청 30초마다 새로고침
    };

    let currentRequestType='urgent';
    let currentUser=localStorage.getItem('userRole')||'secretary';

    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('userRole').value=currentUser;
      updateUserInterface();
      updateDateTime();
      // 최초 1회 미팅 동기화 & 목록 로드
      refreshMeetingsIfScheduled(true);
      loadMeetings();
      loadChatHistory();
      countOpenRequests();
      loadRecentRequests();
      // 채팅/요청 주기 새로고침
      setInterval(()=>{loadChatHistory();countOpenRequests();loadRecentRequests();},CONFIG.AUTO_REFRESH);
      // 스케줄 체크(5분마다 08:00/12:00 근처에서만 실행)
      setInterval(()=>refreshMeetingsIfScheduled(false),5*60*1000);
      setInterval(updateDateTime,1000);
    });

    function switchUserRole(){
      currentUser=document.getElementById('userRole').value;localStorage.setItem('userRole',currentUser);updateUserInterface();showToast('👤',`${currentUser==='ceo'?'대표님':'비서'} 모드로 전환되었습니다`)
    }

    function updateUserInterface(){
      const isCEO=currentUser==='ceo';
      document.getElementById('panelTitle').textContent=isCEO?'📤 비서에게 전달':'📤 대표님께 전달';
      document.getElementById('currentUserDisplay').textContent=isCEO?'대표님 모드':'비서 모드';
      document.getElementById('sendButtonText').textContent=isCEO?'비서에게 전송 (슬랙 DM)':'대표님께 전송 (슬랙 DM)';
      document.getElementById('urgentMessage').placeholder=isCEO?'비서에게 전달할 내용을 입력하세요...':'대표님께 전달할 내용을 입력하세요...';
      const signBtn=document.getElementById('signBtn');
      if(isCEO){signBtn.style.opacity='0.5';signBtn.style.cursor='not-allowed';signBtn.disabled=true}else{signBtn.style.opacity='1';signBtn.style.cursor='pointer';signBtn.disabled=false}
      // 업무 지시 입력창 토글
      document.getElementById('directiveInputWrap').style.display=isCEO?'block':'none';
    }

    function setRequestType(ev,type){
      if(currentUser==='ceo'&&type==='sign'){showToast('⚠️','서명 요청은 비서만 사용 가능합니다');return}
      currentRequestType=type;document.querySelectorAll('.request-type-btn').forEach(b=>b.classList.remove('active'));ev.target.classList.add('active');
      document.getElementById('reserveGuide').style.display=type==='reserve'?'block':'none';
    }

    function updateDateTime(){
      const now=new Date();
      document.getElementById('currentDate').textContent=now.toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});
      document.getElementById('currentTime').textContent=now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    }

    // === Apps Script 호출: JSONP만 사용해 CORB 제거 ===
    function callGAS(method, path, data = {}) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + Math.floor(Math.random() * 1000);
        let settled = false;
        const timeout = setTimeout(() => {
          // ⛔ 타임아웃이 나도 콜백을 지우지 않습니다 (뒤늦게 로드돼도 에러 방지)
          if (!settled) reject(new Error('Request timeout'));
        }, 30000); // 30초

        window[cb] = (res) => {
          if (settled) return;
          settled = true;
          clearTimeout(timeout);
          try { document.body.removeChild(script); } catch(_) {}
          resolve(res);
          // 성공 시 정리
          delete window[cb];
        };

        let url = `${CONFIG.GAS_URL}?path=${encodeURIComponent(path)}&token=${encodeURIComponent(CONFIG.TOKEN)}&callback=${cb}`;
        if (method === 'POST') {
          url += `&method=POST&body=${encodeURIComponent(JSON.stringify(data))}`;
        }

        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => {
          if (settled) return;
          settled = true;
          clearTimeout(timeout);
          try { document.body.removeChild(script); } catch(_) {}
          // 에러여도 콜백은 지우지 않아 뒤늦은 호출을 허용
          reject(new Error('Script load error'));
        };
        script.onload = () => {
          // JSONP는 로드 직후가 아니라 약간 뒤에 cb가 호출될 수 있음
        };
        document.body.appendChild(script);
      });
    }

    // 미팅: 08:00/12:00 근처에서만 refresh
    async function refreshMeetingsIfScheduled(onLoad){
      try{
        const now=new Date();
        const hh=now.getHours(), mm=now.getMinutes();
        const near=(h)=>hh===h&&(mm>=0&&mm<=2); // ±2분 윈도우
        if(onLoad||near(8)||near(12)){
          const r=await callGAS('GET','meetings/refresh');
          if(r.inserted>0||r.removed>0){showToast('📅',`미팅 업데이트: ${r.inserted}개 추가, ${r.removed}개 제거`)}
          await loadMeetings();
        }
      }catch(e){console.error('미팅 동기화 실패:',e)}
    }

    async function loadMeetings(){
      try{
        const data=await callGAS('GET','meetings/list');
        const list=document.getElementById('meetingList');
        const items=data.items||[];document.getElementById('meetingCount').textContent=items.length+'건';
        if(items.length===0){list.innerHTML='<div style="text-align:center;color:#999;">오늘 미팅이 없습니다</div>';return}
        items.sort((a,b)=> (a.start_time||'').localeCompare(b.start_time||''));
        const now=new Date();const curMin=now.getHours()*60+now.getMinutes();
        list.innerHTML=items.map(m=>{
          let status='', cls='';
          if(m.start_time){const [h,mi]=(m.start_time||'0:0').split(':').map(Number);const mt=h*60+mi;
            if(mt<curMin-60){status='✅ 완료';cls='completed'}
            else if(Math.abs(mt-curMin)<30){status='🔄 진행중';cls='ongoing'}
            else if(mt>curMin){status='⏰ 예정';cls='upcoming'}
          }
          return `<div class="meeting-item ${cls}"><div class="meeting-time">${m.start_time||'시간 미정'} ${status}</div><div class="meeting-title">${m.title||''}</div><div class="meeting-detail">📍 ${m.location||'장소 미정'} ${m.link?`| <a href="${m.link}" target="_blank">🔗 링크</a>`:''}</div></div>`
        }).join('');
      }catch(e){console.error('미팅 로드 실패:',e)}
    }

    async function loadChatHistory(){
      try{
        const data=await callGAS('GET','chat/history');
        const c=document.getElementById('chatContainer');
        const items=data.items||[];if(items.length===0){c.innerHTML='<div style="text-align:center;color:#999;">대화 내역이 없습니다</div>';return}
        c.innerHTML=items.map(msg=>{
          const sent=msg.user==='bot'||!msg.user;let klass=sent?'sent':'received';let txt=msg.text;
          if(txt.includes('[긴급]')) txt=`🚨 ${txt}`; else if(txt.includes('[서명요청]')) txt=`✍️ ${txt}`; else if(/(예약|일정|미팅)/.test(txt)) txt=`📅 ${txt}`;
          const ts=new Date(parseFloat(msg.ts)*1000).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
          return `<div class="chat-message ${klass}"><div>${txt}</div><div class="chat-time">${ts}</div></div>`
        }).join('');
        c.scrollTop=c.scrollHeight;
      }catch(e){console.error('채팅 로드 실패:',e)}
    }

    async function countOpenRequests(){
      try{const d=await callGAS('GET','requests/count');document.getElementById('openRequests').textContent=d.open||0}catch(e){console.error('요청 수 확인 실패:',e)}
    }

    async function loadRecentRequests(){
      try{
        const d=await callGAS('GET','requests/list');
        const list=document.getElementById('requestList');
        const items=d.items||[];if(items.length===0){list.innerHTML='<div style="text-align:center;color:#999;">내역이 없습니다</div>';return}
        list.innerHTML=items.slice(0,12).map(req=>{
          let icon='📌'; if(req.type==='urgent') icon='🚨'; else if(req.type==='sign') icon='✍️'; else if(req.type==='reserve') icon='📅'; else if(req.type==='task') icon='🧭';
          let sc='status-open'; if(req.status==='doing') sc='status-doing'; else if(req.status==='done') sc='status-done';
          const time=new Date(req.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
          const from=req.from==='ceo'?'👤 대표님':'👩‍💼 비서';
          const title=(req.message||'').substring(0,30)+(req.message&&req.message.length>30?'...':'');
          return `<div class="request-item"><div><div style="font-weight:600;">${icon} ${title}</div><div style="font-size:12px;color:#999;margin-top:5px;">${from} • ${time}</div></div><span class="request-status ${sc}">${req.status==='open'?'대기':req.status==='doing'?'처리중':'완료'}</span></div>`
        }).join('');
      }catch(e){console.error('요청 로드 실패:',e)}
    }

    async function sendRequest(){
      const message=document.getElementById('urgentMessage').value.trim(); if(!message){showToast('⚠️','메시지를 입력해주세요');return}
      try{
        showToast('⏳','전송 중...');
        await callGAS('POST','requests/create',{type:currentRequestType,from:currentUser,message,priority:currentRequestType==='urgent'?'high':'normal'});
        document.getElementById('urgentMessage').value='';
        showToast('✅',`${currentUser==='ceo'?'비서':'대표님'}에게 슬랙 DM 전송 완료`);
        countOpenRequests(); loadRecentRequests(); setTimeout(loadChatHistory,800);
      }catch(e){showToast('❌','전송 실패: '+e.message)}
    }

    async function sendDirective(){
      const message=document.getElementById('directiveInput').value.trim(); if(!message){showToast('⚠️','업무 지시 내용을 입력해주세요');return}
      try{
        showToast('⏳','등록 중...');
        await callGAS('POST','requests/create',{type:'task',from:'ceo',message,priority:'normal'});
        document.getElementById('directiveInput').value='';
        showToast('✅','업무 지시가 등록되었습니다');
        countOpenRequests(); loadRecentRequests();
      }catch(e){showToast('❌','등록 실패: '+e.message)}
    }

    function showToast(icon,msg){const t=document.getElementById('toast');document.getElementById('toastIcon').textContent=icon;document.getElementById('toastMessage').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
