<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ëŒ€í‘œë‹˜ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#fff;border-radius:15px;padding:25px;margin-bottom:25px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header h1{font-size:28px;color:#333;margin-bottom:10px}
    .status-bar{display:flex;gap:20px;align-items:center}
    .status-item{display:flex;align-items:center;gap:8px;padding:8px 15px;background:#f0f0f0;border-radius:20px;font-size:14px}
    .status-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .main-grid{display:grid;grid-template-columns:2fr 1fr;gap:25px}
    @media (max-width:1024px){.main-grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
    .card-title{font-size:20px;font-weight:600;color:#333}
    .badge{padding:5px 12px;background:#667eea;color:#fff;border-radius:15px;font-size:12px;font-weight:600}
    .urgent-panel{background:linear-gradient(135deg,#f59e0b 0%,#ea580c 100%);color:#fff;border-radius:15px;padding:20px;margin-bottom:25px}
    .request-types{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px}
    .request-type-btn{padding:10px;background:rgba(255,255,255,.2);border:2px solid transparent;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:all .3s}
    .request-type-btn.active{background:rgba(255,255,255,.3);border-color:#fff}
    .message-input{width:100%;padding:15px;border:none;border-radius:10px;font-size:16px;margin-bottom:15px;resize:vertical;min-height:100px}
    .action-buttons{display:flex;gap:10px}
    .btn{padding:12px 25px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:8px}
    .btn-send{background:#fff;color:#ea580c}
    .btn-send:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .meeting-list{max-height:400px;overflow-y:auto}
    .meeting-item{padding:15px;background:#f8f9fa;border-radius:10px;margin-bottom:10px;border-left:4px solid #667eea;transition:all .3s}
    .meeting-item:hover{transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .meeting-time{font-size:14px;font-weight:600;color:#666;margin-bottom:5px}
    .meeting-title{font-size:16px;font-weight:600;color:#333;margin-bottom:5px}
    .meeting-detail{font-size:13px;color:#666}
    .chat-container{height:300px;overflow-y:auto;padding:15px;background:#f8f9fa;border-radius:10px;margin-bottom:15px}
    .chat-message{margin-bottom:15px;padding:10px;background:#fff;border-radius:10px}
    .chat-message.sent{background:#667eea;color:#fff;margin-left:20%}
    .chat-message.received{margin-right:20%}
    .chat-time{font-size:11px;opacity:.7;margin-top:5px}
    .chat-input-group{display:flex;gap:10px}
    .chat-input{flex:1;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    .request-list{max-height:420px;overflow-y:auto}
    .request-item{padding:12px;background:#f8f9fa;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .request-status{padding:5px 10px;border-radius:5px;font-size:12px;font-weight:600}
    .status-open{background:#fef3c7;color:#d97706}
    .status-doing{background:#dbeafe;color:#2563eb}
    .status-done{background:#d1fae5;color:#059669}
    .meeting-item.completed{opacity:.6;background:#e8e8e8}
    .meeting-item.ongoing{background:#fff8e1;border-left-color:#ff9800;animation:pulse-border 2s infinite}
    @keyframes pulse-border{0%,100%{border-left-width:4px}50%{border-left-width:6px}}
    .meeting-item.upcoming{background:#e8f5e9;border-left-color:#4caf50}
    .chat-message.schedule-request{background:#fff3e0!important;color:#333!important;border:1px solid #ff9800}
    .toast{position:fixed;top:20px;right:20px;padding:15px 20px;background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.2);display:none;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.show{display:flex;align-items:center;gap:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
      <div class="status-bar">
        <div class="status-item"><div class="status-dot"></div><span>ì‹¤ì‹œê°„ ë™ê¸°í™”</span></div>
        <div class="status-item">ğŸ“… <span id="currentDate"></span></div>
        <div class="status-item">â° <span id="currentTime"></span></div>
        <div class="status-item">ğŸ‘¤
          <select id="userRole" onchange="switchUserRole()" style="padding:2px 5px;border-radius:4px">
            <option value="secretary">ë¹„ì„œ ëª¨ë“œ</option>
            <option value="ceo">ëŒ€í‘œë‹˜ ëª¨ë“œ</option>
          </select>
        </div>
        <div class="status-item">ğŸ“Œ ì—´ë¦° ìš”ì²­: <strong id="openRequests">0</strong>ê±´</div>
      </div>
    </div>

    <!-- ê¸´ê¸‰/ì„œëª…/ì˜ˆì•½ íŒ¨ë„ (íŒŒì¼ì²¨ë¶€ ì œê±°) -->
    <div class="urgent-panel">
      <h3 style="margin-bottom:15px" id="panelTitle">ğŸ“¤ ê¸´ê¸‰ ì „ë‹¬</h3>
      <div class="request-types">
        <button class="request-type-btn active" onclick="setRequestType(event,'urgent')">ğŸš¨ ê¸´ê¸‰ ìš”ì²­</button>
        <button class="request-type-btn" id="signBtn" onclick="setRequestType(event,'sign')">âœï¸ ì„œëª… ìš”ì²­</button>
        <button class="request-type-btn" onclick="setRequestType(event,'reserve')">ğŸ“… ì˜ˆì•½/ì¼ì •</button>
      </div>
      <div style="background:rgba(255,255,255,.2);padding:10px;border-radius:8px;margin:10px 0;font-size:13px">
        ğŸ’¡ <strong>í˜„ì¬:</strong> <span id="currentUserDisplay">ë¹„ì„œ ëª¨ë“œ</span>
        <div id="reserveGuide" style="display:none;margin-top:5px;padding-top:5px;border-top:1px solid rgba(255,255,255,.3)">
          ğŸ“… <strong>ì˜ˆì•½/ì¼ì • ì‚¬ìš©ë²•:</strong><br />
          â€¢ ëŒ€í‘œë‹˜: ì˜ˆì•½ ìš”ì²­ ì…ë ¥ (ì˜ˆ: "ë‚´ì¼ 3ì‹œ Aì‚¬ ë¯¸íŒ… ì¡ì•„ì£¼ì„¸ìš”")<br />
          â€¢ ë¹„ì„œ: ì˜ˆì•½ ì™„ë£Œ í›„ ê²°ê³¼ ì…ë ¥ (ì˜ˆ: "Aì‚¬ ë¯¸íŒ… 15ì‹œ í™•ì •")
        </div>
      </div>
      <textarea class="message-input" id="urgentMessage" placeholder="ê¸´ê¸‰í•˜ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      <div class="action-buttons">
        <button class="btn btn-send" onclick="sendRequest()">
          <span>ğŸ“¤</span><span id="sendButtonText">ìŠ¬ë™ DMìœ¼ë¡œ ì „ì†¡</span>
        </button>
      </div>
    </div>

    <div class="main-grid">
      <div>
        <!-- ì˜¤ëŠ˜ì˜ ë¯¸íŒ… -->
        <div class="card" style="margin-bottom:25px">
          <div class="card-header">
            <div class="card-title">ğŸ“… ì˜¤ëŠ˜ì˜ ë¯¸íŒ…</div>
            <div style="display:flex;align-items:center;gap:10px">
              <span class="badge" id="meetingCount">0ê±´</span>
              <span style="font-size:12px;color:#999">ğŸ’œ ìŠ¬ë™ #ë¯¸íŒ…-í˜„í™©</span>
            </div>
          </div>
          <div class="meeting-list" id="meetingList">
            <div style="text-align:center;color:#999">ìŠ¬ë™ ì±„ë„ì—ì„œ ë¯¸íŒ… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
          <div style="margin-top:10px;padding:10px;background:#f0f0f0;border-radius:8px;font-size:12px;color:#666">
            ğŸ’¡ ë¯¸íŒ… ì •ë³´ëŠ” ìŠ¬ë™ #ë¯¸íŒ…-í˜„í™© ì±„ë„ì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤ (ë§¤ì¼ 08:00/12:00)
          </div>
        </div>

        <!-- ìŠ¬ë™ DM ëŒ€í™” -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ’¬ ìŠ¬ë™ DM ëŒ€í™”</div>
            <span class="badge">ì‹¤ì‹œê°„</span>
          </div>
          <div style="background:#f0f8ff;padding:10px;border-radius:8px;margin-bottom:15px;font-size:13px">
            ğŸ“Œ <strong>ëŒ€í™” ë‚´ì—­:</strong> ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ì™€ ìŠ¬ë™ DM ëŒ€í™”ê°€ ëª¨ë‘ í‘œì‹œë©ë‹ˆë‹¤
          </div>
          <div class="chat-container" id="chatContainer">
            <div style="text-align:center;color:#999">ëŒ€í™” ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
          <div class="chat-input-group">
            <input type="text" class="chat-input" id="chatInput" placeholder="ë¹ ë¥¸ ë‹µë³€ ì…ë ¥..." onkeypress="if(event.key==='Enter') sendChat()" />
            <button class="btn btn-send" onclick="sendChat()" style="padding:10px 20px">ì „ì†¡</button>
          </div>
        </div>
      </div>

      <div>
        <!-- ì—…ë¬´ ì§€ì‹œ (ìš”ì²­ í˜„í™© ëŒ€ì²´) -->
        <div class="card" style="margin-bottom:25px">
          <div class="card-header">
            <div class="card-title">ğŸ§­ ì—…ë¬´ ì§€ì‹œ</div>
          </div>

          <!-- ëŒ€í‘œë‹˜ ëª¨ë“œì—ì„œë§Œ ì…ë ¥ì°½ ë…¸ì¶œ -->
          <div id="directiveInputWrap" style="display:none;margin-bottom:12px">
            <textarea class="message-input" id="directiveInput" placeholder="ëŒ€í‘œë‹˜ ì§€ì‹œ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            <div class="action-buttons">
              <button class="btn btn-send" onclick="sendDirective()">ğŸ§­ ì§€ì‹œ ë“±ë¡</button>
            </div>
          </div>

          <div class="request-list" id="requestList">
            <div style="text-align:center;color:#999">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastIcon">âœ…</span><span id="toastMessage">ë©”ì‹œì§€</span></div>

  <script>
    const CONFIG={
      GAS_URL:'https://script.google.com/a/macros/cafe24corp.com/s/AKfycbxKdSjsv-9Nn8rH-MG1A4KXmUsqoeAAOe8T9EjrnNKQgX9M1-DrswWZANq0AcgTmwiSPA/exec', // Apps Script ë°°í¬ URL
      TOKEN:'7c1e4a9fdb2e4930b58c6e91d7a4b235', // GAS TOKENê³¼ ë™ì¼
      AUTO_REFRESH:30000 // ì±„íŒ…/ìš”ì²­ 30ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨
    };

    let currentRequestType='urgent';
    let currentUser=localStorage.getItem('userRole')||'secretary';

    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('userRole').value=currentUser;
      updateUserInterface();
      updateDateTime();
      // ìµœì´ˆ 1íšŒ ë¯¸íŒ… ë™ê¸°í™” & ëª©ë¡ ë¡œë“œ
      refreshMeetingsIfScheduled(true);
      loadMeetings();
      loadChatHistory();
      countOpenRequests();
      loadRecentRequests();
      // ì±„íŒ…/ìš”ì²­ ì£¼ê¸° ìƒˆë¡œê³ ì¹¨
      setInterval(()=>{loadChatHistory();countOpenRequests();loadRecentRequests();},CONFIG.AUTO_REFRESH);
      // ìŠ¤ì¼€ì¤„ ì²´í¬(5ë¶„ë§ˆë‹¤ 08:00/12:00 ê·¼ì²˜ì—ì„œë§Œ ì‹¤í–‰)
      setInterval(()=>refreshMeetingsIfScheduled(false),5*60*1000);
      setInterval(updateDateTime,1000);
    });

    function switchUserRole(){
      currentUser=document.getElementById('userRole').value;localStorage.setItem('userRole',currentUser);updateUserInterface();showToast('ğŸ‘¤',`${currentUser==='ceo'?'ëŒ€í‘œë‹˜':'ë¹„ì„œ'} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤`)
    }

    function updateUserInterface(){
      const isCEO=currentUser==='ceo';
      document.getElementById('panelTitle').textContent=isCEO?'ğŸ“¤ ë¹„ì„œì—ê²Œ ì „ë‹¬':'ğŸ“¤ ëŒ€í‘œë‹˜ê»˜ ì „ë‹¬';
      document.getElementById('currentUserDisplay').textContent=isCEO?'ëŒ€í‘œë‹˜ ëª¨ë“œ':'ë¹„ì„œ ëª¨ë“œ';
      document.getElementById('sendButtonText').textContent=isCEO?'ë¹„ì„œì—ê²Œ ì „ì†¡ (ìŠ¬ë™ DM)':'ëŒ€í‘œë‹˜ê»˜ ì „ì†¡ (ìŠ¬ë™ DM)';
      document.getElementById('urgentMessage').placeholder=isCEO?'ë¹„ì„œì—ê²Œ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...':'ëŒ€í‘œë‹˜ê»˜ ì „ë‹¬í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...';
      const signBtn=document.getElementById('signBtn');
      if(isCEO){signBtn.style.opacity='0.5';signBtn.style.cursor='not-allowed';signBtn.disabled=true}else{signBtn.style.opacity='1';signBtn.style.cursor='pointer';signBtn.disabled=false}
      // ì—…ë¬´ ì§€ì‹œ ì…ë ¥ì°½ í† ê¸€
      document.getElementById('directiveInputWrap').style.display=isCEO?'block':'none';
    }

    function setRequestType(ev,type){
      if(currentUser==='ceo'&&type==='sign'){showToast('âš ï¸','ì„œëª… ìš”ì²­ì€ ë¹„ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤');return}
      currentRequestType=type;document.querySelectorAll('.request-type-btn').forEach(b=>b.classList.remove('active'));ev.target.classList.add('active');
      document.getElementById('reserveGuide').style.display=type==='reserve'?'block':'none';
    }

    function updateDateTime(){
      const now=new Date();
      document.getElementById('currentDate').textContent=now.toLocaleDateString('ko-KR',{month:'long',day:'numeric',weekday:'short'});
      document.getElementById('currentTime').textContent=now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    }

    // === Apps Script í˜¸ì¶œ: JSONPë§Œ ì‚¬ìš©í•´ CORB ì œê±° ===
    function callGAS(method, path, data = {}) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + Math.floor(Math.random() * 1000);
        let settled = false;
        const timeout = setTimeout(() => {
          // â›” íƒ€ì„ì•„ì›ƒì´ ë‚˜ë„ ì½œë°±ì„ ì§€ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤ (ë’¤ëŠ¦ê²Œ ë¡œë“œë¼ë„ ì—ëŸ¬ ë°©ì§€)
          if (!settled) reject(new Error('Request timeout'));
        }, 30000); // 30ì´ˆ

        window[cb] = (res) => {
          if (settled) return;
          settled = true;
          clearTimeout(timeout);
          try { document.body.removeChild(script); } catch(_) {}
          resolve(res);
          // ì„±ê³µ ì‹œ ì •ë¦¬
          delete window[cb];
        };

        let url = `${CONFIG.GAS_URL}?path=${encodeURIComponent(path)}&token=${encodeURIComponent(CONFIG.TOKEN)}&callback=${cb}`;
        if (method === 'POST') {
          url += `&method=POST&body=${encodeURIComponent(JSON.stringify(data))}`;
        }

        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => {
          if (settled) return;
          settled = true;
          clearTimeout(timeout);
          try { document.body.removeChild(script); } catch(_) {}
          // ì—ëŸ¬ì—¬ë„ ì½œë°±ì€ ì§€ìš°ì§€ ì•Šì•„ ë’¤ëŠ¦ì€ í˜¸ì¶œì„ í—ˆìš©
          reject(new Error('Script load error'));
        };
        script.onload = () => {
          // JSONPëŠ” ë¡œë“œ ì§í›„ê°€ ì•„ë‹ˆë¼ ì•½ê°„ ë’¤ì— cbê°€ í˜¸ì¶œë  ìˆ˜ ìˆìŒ
        };
        document.body.appendChild(script);
      });
    }

    // ë¯¸íŒ…: 08:00/12:00 ê·¼ì²˜ì—ì„œë§Œ refresh
    async function refreshMeetingsIfScheduled(onLoad){
      try{
        const now=new Date();
        const hh=now.getHours(), mm=now.getMinutes();
        const near=(h)=>hh===h&&(mm>=0&&mm<=2); // Â±2ë¶„ ìœˆë„ìš°
        if(onLoad||near(8)||near(12)){
          const r=await callGAS('GET','meetings/refresh');
          if(r.inserted>0||r.removed>0){showToast('ğŸ“…',`ë¯¸íŒ… ì—…ë°ì´íŠ¸: ${r.inserted}ê°œ ì¶”ê°€, ${r.removed}ê°œ ì œê±°`)}
          await loadMeetings();
        }
      }catch(e){console.error('ë¯¸íŒ… ë™ê¸°í™” ì‹¤íŒ¨:',e)}
    }

    async function loadMeetings(){
      try{
        const data=await callGAS('GET','meetings/list');
        const list=document.getElementById('meetingList');
        const items=data.items||[];document.getElementById('meetingCount').textContent=items.length+'ê±´';
        if(items.length===0){list.innerHTML='<div style="text-align:center;color:#999;">ì˜¤ëŠ˜ ë¯¸íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>';return}
        items.sort((a,b)=> (a.start_time||'').localeCompare(b.start_time||''));
        const now=new Date();const curMin=now.getHours()*60+now.getMinutes();
        list.innerHTML=items.map(m=>{
          let status='', cls='';
          if(m.start_time){const [h,mi]=(m.start_time||'0:0').split(':').map(Number);const mt=h*60+mi;
            if(mt<curMin-60){status='âœ… ì™„ë£Œ';cls='completed'}
            else if(Math.abs(mt-curMin)<30){status='ğŸ”„ ì§„í–‰ì¤‘';cls='ongoing'}
            else if(mt>curMin){status='â° ì˜ˆì •';cls='upcoming'}
          }
          return `<div class="meeting-item ${cls}"><div class="meeting-time">${m.start_time||'ì‹œê°„ ë¯¸ì •'} ${status}</div><div class="meeting-title">${m.title||''}</div><div class="meeting-detail">ğŸ“ ${m.location||'ì¥ì†Œ ë¯¸ì •'} ${m.link?`| <a href="${m.link}" target="_blank">ğŸ”— ë§í¬</a>`:''}</div></div>`
        }).join('');
      }catch(e){console.error('ë¯¸íŒ… ë¡œë“œ ì‹¤íŒ¨:',e)}
    }

    async function loadChatHistory(){
      try{
        const data=await callGAS('GET','chat/history');
        const c=document.getElementById('chatContainer');
        const items=data.items||[];if(items.length===0){c.innerHTML='<div style="text-align:center;color:#999;">ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';return}
        c.innerHTML=items.map(msg=>{
          const sent=msg.user==='bot'||!msg.user;let klass=sent?'sent':'received';let txt=msg.text;
          if(txt.includes('[ê¸´ê¸‰]')) txt=`ğŸš¨ ${txt}`; else if(txt.includes('[ì„œëª…ìš”ì²­]')) txt=`âœï¸ ${txt}`; else if(/(ì˜ˆì•½|ì¼ì •|ë¯¸íŒ…)/.test(txt)) txt=`ğŸ“… ${txt}`;
          const ts=new Date(parseFloat(msg.ts)*1000).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
          return `<div class="chat-message ${klass}"><div>${txt}</div><div class="chat-time">${ts}</div></div>`
        }).join('');
        c.scrollTop=c.scrollHeight;
      }catch(e){console.error('ì±„íŒ… ë¡œë“œ ì‹¤íŒ¨:',e)}
    }

    async function countOpenRequests(){
      try{const d=await callGAS('GET','requests/count');document.getElementById('openRequests').textContent=d.open||0}catch(e){console.error('ìš”ì²­ ìˆ˜ í™•ì¸ ì‹¤íŒ¨:',e)}
    }

    async function loadRecentRequests(){
      try{
        const d=await callGAS('GET','requests/list');
        const list=document.getElementById('requestList');
        const items=d.items||[];if(items.length===0){list.innerHTML='<div style="text-align:center;color:#999;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';return}
        list.innerHTML=items.slice(0,12).map(req=>{
          let icon='ğŸ“Œ'; if(req.type==='urgent') icon='ğŸš¨'; else if(req.type==='sign') icon='âœï¸'; else if(req.type==='reserve') icon='ğŸ“…'; else if(req.type==='task') icon='ğŸ§­';
          let sc='status-open'; if(req.status==='doing') sc='status-doing'; else if(req.status==='done') sc='status-done';
          const time=new Date(req.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
          const from=req.from==='ceo'?'ğŸ‘¤ ëŒ€í‘œë‹˜':'ğŸ‘©â€ğŸ’¼ ë¹„ì„œ';
          const title=(req.message||'').substring(0,30)+(req.message&&req.message.length>30?'...':'');
          return `<div class="request-item"><div><div style="font-weight:600;">${icon} ${title}</div><div style="font-size:12px;color:#999;margin-top:5px;">${from} â€¢ ${time}</div></div><span class="request-status ${sc}">${req.status==='open'?'ëŒ€ê¸°':req.status==='doing'?'ì²˜ë¦¬ì¤‘':'ì™„ë£Œ'}</span></div>`
        }).join('');
      }catch(e){console.error('ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:',e)}
    }

    async function sendRequest(){
      const message=document.getElementById('urgentMessage').value.trim(); if(!message){showToast('âš ï¸','ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');return}
      try{
        showToast('â³','ì „ì†¡ ì¤‘...');
        await callGAS('POST','requests/create',{type:currentRequestType,from:currentUser,message,priority:currentRequestType==='urgent'?'high':'normal'});
        document.getElementById('urgentMessage').value='';
        showToast('âœ…',`${currentUser==='ceo'?'ë¹„ì„œ':'ëŒ€í‘œë‹˜'}ì—ê²Œ ìŠ¬ë™ DM ì „ì†¡ ì™„ë£Œ`);
        countOpenRequests(); loadRecentRequests(); setTimeout(loadChatHistory,800);
      }catch(e){showToast('âŒ','ì „ì†¡ ì‹¤íŒ¨: '+e.message)}
    }

    async function sendDirective(){
      const message=document.getElementById('directiveInput').value.trim(); if(!message){showToast('âš ï¸','ì—…ë¬´ ì§€ì‹œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');return}
      try{
        showToast('â³','ë“±ë¡ ì¤‘...');
        await callGAS('POST','requests/create',{type:'task',from:'ceo',message,priority:'normal'});
        document.getElementById('directiveInput').value='';
        showToast('âœ…','ì—…ë¬´ ì§€ì‹œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        countOpenRequests(); loadRecentRequests();
      }catch(e){showToast('âŒ','ë“±ë¡ ì‹¤íŒ¨: '+e.message)}
    }

    function showToast(icon,msg){const t=document.getElementById('toast');document.getElementById('toastIcon').textContent=icon;document.getElementById('toastMessage').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
  </script>
</body>
</html>
